---
title: "deseq2_dmsotc_mf"
author: "Lina Kim"
date: "October 4, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.path = "images/")
```

## Setup 

### Setup for DESeq2

```{r setup.deseq2}
library(DESeq2)
library(ballgown)
```

### Setup for differential expression analysis

```{r setup.deg, cache=TRUE}
library(AnnotationDbi)
library(org.Mm.eg.db)
library(DOSE)
library(pathview)
library(purrr)
library(clusterProfiler)
library(biomaRt)
ensembl <- useMart("ensembl",dataset="mmusculus_gene_ensembl")
data_path <- "D:/Lina/Documents/share/mouse/hisat2/"

mstrg_ens <- read.table(paste(data_path,'merged.annotated.for_ens_id.csv',sep=""), header=TRUE, sep=',')
```

## Differential Expression Analysis

```{r deseq2}
# Read in expression data calculated by StringTie
dmsotc_mf.pheno_data <- read.csv(paste(data_path,'group_phenodata_csv/dmsotc_mf_phenodata.csv',sep=""))
dmsotc_mf.bg_chr <- ballgown(dataDir=paste(data_path,'ballgown_dmsotc_mf',sep=""), samplePattern='D18', pData=dmsotc_mf.pheno_data)

# Filter to remove low-abundance genes
dmsotc_mf.bg_chr_filt <- subset(dmsotc_mf.bg_chr, 'rowVars(texpr(dmsotc_mf.bg_chr))>10', genomesubset=TRUE)

# Create key-value pairs for MSTRG IDs (from Stringtie) to gene names
dmsotc_mf.bg_chr.kv <- setNames(as.list(ballgown::geneNames(dmsotc_mf.bg_chr)),as.list(ballgown::geneIDs(dmsotc_mf.bg_chr)))

dmsotc_mf.countData <- as.matrix(read.csv(paste(data_path,'ballgown_dmsotc_mf/gene_count_matrix.csv',sep=""),row.names='gene_id'))
# Manually changed phenodata file to replace hyphens with periods, since read.csv did so above
dmsotc_mf.colData <- read.table(paste(data_path,'group_phenodata_csv/dmsotc_mf_phenodata_corrected.csv',sep=""), row.names=1, header=TRUE, sep=',')

dds.dmsotc_mf <- DESeqDataSetFromMatrix(countData=dmsotc_mf.countData, colData=dmsotc_mf.colData, design = ~ sex)
dds.dmsotc_mf <- DESeq(dds.dmsotc_mf)
res.dmsotc_mf <- results(dds.dmsotc_mf)
resOrdered.dmsotc_mf <- res.dmsotc_mf[order(res.dmsotc_mf$padj),]
geneIDs.dmsotc_mf_og <- rownames(resOrdered.dmsotc_mf)
geneList.dmsotc_mf <- lapply(geneIDs.dmsotc_mf_og, function(id) {
  return(dmsotc_mf.bg_chr.kv[[id]])
})
resOrdered.dmsotc_mf <- cbind(unlist(geneList.dmsotc_mf), resOrdered.dmsotc_mf)
colnames(resOrdered.dmsotc_mf) <- c('geneName',colnames(resOrdered.dmsotc_mf)[-1])

# Added to include Ensembl IDs
geneIDs.dmsotc_mf <- lapply(geneIDs.dmsotc_mf_og, function(id) {
  if (id %in% mstrg_ens$gene_id) {
    return(as.character(mstrg_ens[mstrg_ens$gene_id == id, "ref_gene_id"]))
  }
  return(as.character(id))
})
geneIDs.dmsotc_mf <- unlist(geneIDs.dmsotc_mf)

resOrdered.dmsotc_mf <- cbind(geneIDs.dmsotc_mf, resOrdered.dmsotc_mf)
colnames(resOrdered.dmsotc_mf) <- c('geneID',colnames(resOrdered.dmsotc_mf)[-1])

#resOrdered.dmsotc_mf <- cbind(unlist(geneList.dmsotc_mf), resOrdered.dmsotc_mf)
#colnames(resOrdered.dmsotc_mf) <- c('geneName',colnames(resOrdered.dmsotc_mf)[-1])

# Added for additional gene names identified via merged GTF
geneList.dmsotc_mf <- apply(resOrdered.dmsotc_mf, 1, function(row) {
  if (row[[2]] == '.' & row[[1]] %in% mstrg_ens$ref_gene_id) {
    return(as.character(mstrg_ens[mstrg_ens$ref_gene_id == row[[1]], "gene_name"]))
  }
  return(as.character(row[[2]]))
})

resOrdered.dmsotc_mf <- resOrdered.dmsotc_mf[,-2]
resOrdered.dmsotc_mf <- cbind(unlist(geneList.dmsotc_mf), resOrdered.dmsotc_mf)
colnames(resOrdered.dmsotc_mf) <- c('geneName',colnames(resOrdered.dmsotc_mf)[-1])

#write.csv(resOrdered.dmsotc_mf, file='all_dmsotc_mf.csv', row.names=FALSE)
```

## Output a clean list of genes

```{r clean-csv}
all.dmsotc_mf <- read.table("all_dmsotc_mf.csv", sep=",", header=TRUE)
all.dmsotc_mf <- all.dmsotc_mf[!is.na(all.dmsotc_mf$padj),]
all.dmsotc_mf$geneID <- as.character(all.dmsotc_mf$geneID)
all.dmsotc_mf <- all.dmsotc_mf[startsWith(all.dmsotc_mf$geneID,'ENSM'),]
all.dmsotc_mf <- all.dmsotc_mf[,c("geneName","geneID","log2FoldChange","padj")]
write.csv(all.dmsotc_mf, file="dmsotc_mf_genes.csv", row.names=FALSE)
```
